import{_ as k,x as w,ah as p,z as y,C as j,k as c,D as O,m as l,K as V,L as v,N as T,l as f,w as m,V as P,q as d,R as x,F as u,v as F,ai as C}from"./index-DSRpE5Rv.js";import{g as D}from"./graphql-B2keRYja.js";import{i as _,a as b}from"./initialOptions-qpNtWc_g.js";import{V as A}from"./vue3-apexcharts.common-fVAFgZnd.js";import{V as q}from"./VPagination-DeW5L5cH.js";import{d as B}from"./debounce-yiAiFcv2.js";const h=new Map([["total",{start:"submittedTime",end:"finishedTime"}],["run",{start:"startedTime",end:"finishedTime"}],["queue",{start:"submittedTime",end:"startedTime"}]]),g=["#008FFB","#00E396","#775DD0","#FEB019","#FF4560"],S={name:"GanttChart",watch:{tasksPerPage:function(){this.page=1}},components:{VueApexCharts:A},props:{jobs:{type:Object,required:!0},timingOption:{type:String,default:"total"},tasksPerPage:{type:Number,default:10},animate:{type:Boolean,default:!0}},setup(){return{reducedAnimation:w()}},data(){return{page:1,sortBy:"name",sortDesc:!1}},methods:{compare(a,e){const s=a[this.sortBy]<e[this.sortBy]?-1:1;return this.sortDesc?-s:s}},computed:{displayedJobs(){const a=Object.keys(this.jobs),e=Math.max(0,this.tasksPerPage*(this.page-1)),s=Math.min(a.length,e+this.tasksPerPage);return Object.values(this.jobs).slice(e,s).flatMap(t=>t)},series(){let a=[];if(this.jobs.length!==0){const{start:e,end:s}=h.get(this.timingOption),t=new Map;let o=0;a=this.displayedJobs.map(i=>{const{cycle:r}=new p(i.id);let n=t.get(r);return n||(n=g[o++%g.length],t.set(r,n)),{x:i.name,y:[new Date(i[e]).getTime(),new Date(i[s]).getTime()],fillColor:n}})}return[{data:a}]},numPages(){return this.jobs.length!==0?Math.ceil(Object.keys(this.jobs).length/this.tasksPerPage):1},chartOptions(){const{displayedJobs:a}=this,{start:e,end:s}=h.get(this.timingOption);return{chart:{animations:{enabled:this.animate&&!this.reducedAnimation,easing:"easeinout",speed:300,animateGradually:{enabled:!0,delay:150},dynamicAnimation:{enabled:!0,speed:350}},fontFamily:"inherit",toolbar:{tools:{download:`<svg class="w-100 h-100"><path d="${y}"></path></svg>`}}},tooltip:{custom({dataPointIndex:t}){const o=a[t],{relativeID:i}=new p(o.id);return'<div class="apexcharts-tooltip-candlestick"><div>Job: <span class="value">'+i+'</span></div><div>Start: <span class="value">'+o[e]+'</span></div><div>Finish: <span class="value">'+o[s]+"</span></div></div>"}},plotOptions:{bar:{horizontal:!0}},xaxis:{labels:{formatter:function(t,o,i){return new Date(t).toTimeString().slice(0,9)}},title:{text:"Time"}},yaxis:{labels:{maxWidth:280,offsetX:-10}}}}}};function G(a,e,s,t,o,i){const r=j("VueApexCharts");return c(),O(V,null,[l(r,{type:"rangeBar",options:i.chartOptions,series:i.series,width:"100%",height:"auto",class:"d-flex justify-center"},null,8,["options","series"]),l(q,{modelValue:o.page,"onUpdate:modelValue":e[0]||(e[0]=n=>o.page=n),length:i.numPages,"total-visible":7,density:"comfortable"},null,8,["modelValue","length"])],64)}const I=k(S,[["render",G]]);function M(a,e){const{name:s,platformOption:t}=e;return Object.fromEntries(Object.entries(a).filter(([o,i])=>(!s.length||s.includes(o))&&(t===-1||i.some(({platform:r})=>r===t))))}function U(a){const e=[{value:-1,title:"All"}],s=[];for(const t of Object.values(a))for(let o=0;o<t.length;o++)s.includes(t[o].platform)||(s.push(t[o].platform),e.push({value:t[o].platform,title:t[o].platform}));return e}const E=["name","id","submittedTime","startedTime","finishedTime","platform"],J=v`
query ganttQuery ($workflows: [ID]) {
  jobs(live: false, workflows: $workflows) {
    ${E.join(`
`)}
  }
}
`;class Q extends T{constructor(){super(),this.jobs={}}add(e){this.uniqueTasks=Array.from(new Set(e.jobs.map(t=>t.name)));const s=Object.fromEntries(this.uniqueTasks.map(t=>[t,[]]));for(let t=0;t<e.jobs.length;t++)s[e.jobs[t].name].push(e.jobs[t]);Object.assign(this.jobs,s)}onAdded(e,s,t){this.add(e)}onUpdated(e,s,t){this.add(e)}}const R={name:"Gantt",mixins:[D],components:{GanttChart:I},props:{initialOptions:_},setup(a,{emit:e}){const s=b("tasksPerPage",{props:a,emit:e},10),t=b("jobsFilter",{props:a,emit:e},{name:[],timingOption:"totalTimes",platformOption:-1});return{tasksPerPage:s,jobsFilter:t}},beforeMount(){this.jobsQuery()},data(){return{callback:new Q,timingOptions:[{value:"totalTimes",title:"Total times"},{value:"runTimes",title:"Run times"},{value:"queueTimes",title:"Queue times"}]}},computed:{workflowIDs(){return[this.workflowId]},filteredJobs(){return M(this.callback.jobs,this.jobsFilter)},platformOptions(){return U(this.callback.jobs)},timingOption(){return this.jobsFilter.timingOption.replace(/Times/,"")}},methods:{jobsQuery:B(async function(){const a=await this.$workflowService.query2(J,{workflows:this.workflowIDs});this.callback.onAdded(a.data)},200)},taskChoices:[10,25,50,100]},N={class:"c-gantt"};function L(a,e,s,t,o,i){const r=j("GanttChart");return c(),O("div",N,[Object.keys(o.callback.jobs).length?(c(),f(P,{key:1,fluid:"",class:"pa-2"},{default:m(()=>[l(F,{"no-gutters":""},{default:m(()=>[l(d,{cols:"12",md:"4",class:"pr-md-2 mb-2"},{default:m(()=>[l(x,{id:"c-gantt-filter-job-name",multiple:"",chips:"","closable-chips":"",clearable:"",placeholder:"Search",items:o.callback.uniqueTasks,modelValue:t.jobsFilter.name,"onUpdate:modelValue":e[0]||(e[0]=n=>t.jobsFilter.name=n),label:"Select tasks",ref:"selectTasks"},null,8,["items","modelValue"])]),_:1}),l(d,{cols:"12",md:"4",class:"mb-2"},{default:m(()=>[l(u,{id:"c-gantt-filter-job-timings",items:o.timingOptions,prefix:"Displaying:",modelValue:t.jobsFilter.timingOption,"onUpdate:modelValue":e[1]||(e[1]=n=>t.jobsFilter.timingOption=n)},null,8,["items","modelValue"])]),_:1}),l(d,{cols:"12",md:"4",class:"pl-md-2 mb-2"},{default:m(()=>[l(u,{id:"c-gantt-filter-job-platforms",items:i.platformOptions,prefix:"Platform:",modelValue:t.jobsFilter.platformOption,"onUpdate:modelValue":e[2]||(e[2]=n=>t.jobsFilter.platformOption=n)},null,8,["items","modelValue"])]),_:1}),l(d,{cols:"12",md:"4",class:"pr-md-2 mb-2"},{default:m(()=>[l(u,{id:"c-gantt-tasks-per-page",items:a.$options.taskChoices,prefix:"Tasks Per Page",modelValue:t.tasksPerPage,"onUpdate:modelValue":e[3]||(e[3]=n=>t.tasksPerPage=n)},null,8,["items","modelValue"])]),_:1})]),_:1}),l(r,{jobs:i.filteredJobs,"timing-option":i.timingOption,"tasks-per-page":t.tasksPerPage},null,8,["jobs","timing-option","tasks-per-page"])]),_:1})):(c(),f(C,{key:0,type:"table",class:"align-content-start"}))])}const Z=k(R,[["render",L]]);export{Q as GanttCallback,Z as default};
