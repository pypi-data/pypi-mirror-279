on:
  push:
    branches:
      - main
    # tags:
      # - "release"
  pull_request:
name: Flatpak
jobs:
  flathub:
    runs-on: ubuntu-latest
    steps:
      - name: "Install yq"
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && \
          chmod +x /usr/bin/yq
      - uses: actions/checkout@v4
        with:
          repository: flathub/org.unofficialrevport.REVHubInterface
      - name: "Get configs"
        run: rm -rf * .git .github .gitignore && git clone https://github.com/unofficial-rev-port/REVHubInterface . && \
          mv flatpak/org.unofficialrevport.REVHubInterface.yml . && \
          mv flatpak/python3-requirements.json . && \
          rm -r -- !(org.unofficialrevport.REVHubInterface.yml|python3-requirements.json)
      - name: "remove old tag"
        run: "yq -i \'del(.modules[2].sources)\' org.unofficialrevport.REVHubInterface.yml"
      - name: "add new tag"
        run: "yq \'.modules[2] += {\"sources\": [{\"type\": \"git\", \"url\": \"https://github.com/unofficial-rev-port/REVHubInterface.git\", \"disable-shallow-clone\": true, \"commit\": \'\"$(git log --format=\\\"%H\\\" -n 1)}]}\" org.unofficialrevport.REVHubInterface.yml"
      - name: Create pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update manifest && python3 requirements"
          title: "Automated release update"
          body: "Automated update of manifest and python3 requirements to flathub"
          branch: master
          